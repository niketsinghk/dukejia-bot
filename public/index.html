<div id="hca-chat-root"></div>
<script>
(() => {
  /* ---------- ICONS (now using external SVGs) ---------- */
  const BASE_ICON_URL = "https://www.svgrepo.com/show/339963/chat-bot.svg";
  const BOT_ICON_URL  = "https://www.svgrepo.com/show/334455/bot.svg";
  const USER_ICON_URL = "https://www.svgrepo.com/show/532363/user-alt-1.svg";

  window.HCA_BASE_ICON = BASE_ICON_URL;
  window.HCA_BOT_ICON  = BOT_ICON_URL;
  window.HCA_USER_ICON = USER_ICON_URL;

  /* ---------- API CONFIG ---------- */
  const API_BASE = window.HCA_API_BASE || "";
  const API_URL  = `${API_BASE}/api/ask`;
  const HEALTH   = `${API_BASE}/api/health`;
  const RESET    = `${API_BASE}/api/reset`; // optional

  /* ---------- Time-based greeting (IST) ---------- */
  function getISTGreeting() {
    const hour = Number(new Intl.DateTimeFormat("en-GB", {
      timeZone: "Asia/Kolkata", hour: "2-digit", hour12: false
    }).format(new Date()));
    if (hour < 5)  return "Good night";
    if (hour < 12) return "Good morning";
    if (hour < 17) return "Good afternoon";
    if (hour < 21) return "Good evening";
    return "Good night";
  }
  function buildWelcomeLine() {
    const g = getISTGreeting();
    return `${g}! I’m HCA Assistant`;
  }

  /* ---------- SESSION ID (persistent across reloads) ---------- */
  function getOrCreateSessionId() {
    const KEY = "hca_session_id";
    try {
      let sid = localStorage.getItem(KEY);
      if (!sid) {
        sid = (crypto && crypto.randomUUID)
          ? crypto.randomUUID()
          : "sid-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem(KEY, sid);
      }
      return sid;
    } catch {
      return (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : "sid-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
  }
  const SESSION_ID = getOrCreateSessionId();

  /* ---------- UI MOUNT ---------- */
  const root = document.getElementById("hca-chat-root");
  root.innerHTML = `
  <style>
    :root{ --hca-blue:#2563eb; --hca-blue-2:#7aa2ff; --hca-bg:#ffffff; --hca-dark:#0f172a; --hca-muted:#6b7280; --hca-radius:16px; }

    .hca-fab{
      position:fixed; right:18px; bottom:18px; width:58px; height:58px; border-radius:50%;
      background:linear-gradient(135deg,var(--hca-blue),var(--hca-blue-2)); color:#fff;
      display:flex; align-items:center; justify-content:center; box-shadow:0 12px 32px rgba(0,0,0,.18);
      cursor:pointer; z-index:9999; font-size:22px; user-select:none;
    }
    .hca-fab img{ width:26px; height:26px; display:block; filter:brightness(0) invert(1); }

    .hca-panel{
      position:fixed; right:24px; bottom:92px; width:380px; height:520px; background:#fff; border-radius:18px;
      box-shadow:0 20px 40px rgba(0,0,0,.22); display:none; flex-direction:column; overflow:hidden; z-index:10000;
    }
    .hca-panel.open{ display:flex; }

    .hca-head{
      background:linear-gradient(135deg,var(--hca-blue),var(--hca-blue-2));
      padding:12px 14px; color:#fff; font:700 16px Inter,system-ui; display:flex; justify-content:space-between; align-items:center;
    }
    .hca-head-left{ display:flex; align-items:center; gap:10px; }
    .hca-head-left img{ width:22px; height:22px; border-radius:6px; filter:brightness(0) invert(1); }
    .hca-actions{ display:flex; gap:8px; }
    .hca-btn{ background:rgba(255,255,255,.2); border:0; color:#fff; width:28px; height:28px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .hca-btn:hover{ background:rgba(255,255,255,.3); }

    .hca-body{ flex:1; background:#f8fafc; padding:12px; overflow:auto; }

    .hca-row{ display:flex; gap:8px; align-items:flex-end; margin:8px 0; }
    .hca-row.user{ justify-content:flex-end; flex-direction:row-reverse; }
    .hca-avatar{ width:28px; height:28px; border-radius:50%; background:#e5e7eb center/contain no-repeat; flex:0 0 28px; }
    .hca-bubble{ max-width:72%; padding:10px 12px; border-radius:14px; font:500 14px/1.5 Inter,system-ui; word-wrap:break-word; }
    .hca-row.bot  .hca-bubble{ background:#fff; color:#111; border:1px solid #e5e7eb; border-bottom-left-radius:6px; }
    .hca-row.user .hca-bubble{ background:#2563eb; color:#fff; border-bottom-right-radius:6px; text-align:right; margin-left:auto; }

    .hca-row.bot .hca-bubble strong{ font-weight:800; }
    .hca-row.bot .hca-bubble em{ font-style:italic; }
    .hca-row.bot .hca-bubble code{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:#f1f5f9; padding:0 .25em; border-radius:4px;
    }
    .hca-row.bot .hca-bubble a{ color:#1d4ed8; text-decoration:none; border-bottom:1px dotted #93c5fd; }
    .hca-row.bot .hca-bubble a:hover{ text-decoration:underline; }

    .hca-row.bot .hca-bubble ul{ margin:6px 0 0 18px; padding:0; }
    .hca-row.bot .hca-bubble li{ margin:4px 0; }

    .hca-foot{ padding:10px; background:#fff; border-top:1px solid #e5e7eb; display:flex; gap:8px; }
    .hca-input{ flex:1; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; font:500 14px Inter,system-ui; }
    .hca-send{ background:#2563eb; color:#fff; border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }
    .hca-send[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Typing indicator */
    .hca-typing-row{display:flex;gap:8px;align-items:flex-end;margin:8px 0;}
    .hca-typing-bubble{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:8px 12px;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 2px 6px rgba(0,0,0,.15);}
    .hca-typing-dot{width:6px;height:6px;border-radius:50%;background:#000;opacity:.4;animation:hcaBlink 1.4s infinite;}
    .hca-typing-dot:nth-child(2){animation-delay:.2s;}
    .hca-typing-dot:nth-child(3){animation-delay:.4s;}
    @keyframes hcaBlink{0%,80%,100%{opacity:.4;transform:translateY(0);}40%{opacity:1;transform:translateY(-2px);} }

    @media (max-width:520px){ .hca-panel{ right:10px; left:10px; width:auto; height:70vh; } }

    /* Hint bubble */
    .hca-hint{
      position:fixed; right:86px; bottom:30px; max-width:240px; background:#fff; color:#0f172a;
      border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; font:600 14px/1.35 Inter,system-ui;
      box-shadow:0 10px 30px rgba(0,0,0,.12); opacity:0; transform:translateY(8px);
      pointer-events:none; transition:opacity .2s ease, transform .2s ease; z-index:10001;
      display:flex; align-items:flex-start; gap:8px;
    }
    .hca-hint.show{ opacity:1; transform:translateY(0); pointer-events:auto; }
    .hca-hint:after{
      content:""; position:absolute; right:-8px; bottom:12px; width:0; height:0;
      border-left:10px solid #fff; border-top:8px solid transparent; border-bottom:8px solid transparent;
    }
    .hca-hint #hca-hint-text{ flex:1 1 auto; }
    .hca-hint .hca-hint-close{ flex:0 0 auto; margin-left:2; font-weight:900; cursor:pointer; opacity:.55; }
    .hca-hint .hca-hint-close:hover{ opacity:1; }

    /* Links visible in both bubbles */
    .hca-bubble a{ text-decoration: underline; }
    .hca-row.user .hca-bubble a{ color:#fff; }
  </style>

  <div class="hca-fab" aria-label="Open HCA Assistant" title="HCA Assistant">
    <img id="hca-fab-icon" alt="Chat"/>
  </div>

  <div class="hca-hint" id="hca-hint" role="status" aria-live="polite">
    <span id="hca-hint-text">Need help with sewing solutions? I’m here.</span>
     <button type="button" class="hca-hint-close" title="Dismiss" aria-label="Dismiss">×</button>
  </div>

  <div class="hca-panel" role="dialog" aria-label="HCA Assistant">
    <div class="hca-head">
      <div class="hca-head-left">
        <img id="hca-head-icon" alt="Assistant"/>
        <span id="hca-title">HCA Assistant</span>
      </div>
      <div class="hca-actions">
        <button class="hca-btn" id="hca-refresh" title="Restart chat" aria-label="Restart chat">⟲</button>
        <button class="hca-btn" id="hca-close" title="Close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="hca-body" id="hca-log"></div>
    <div class="hca-foot">
      <input class="hca-input" id="hca-input" placeholder="Ask something…"/>
      <button class="hca-send" id="hca-send">Send</button>
    </div>
  </div>
  `;

  /* ---------- Shortcuts ---------- */
  const $ = sel => root.querySelector(sel);
  const fab = $(".hca-fab");
  const panel = $(".hca-panel");
  const closeBtn = $("#hca-close");
  const refreshBtn = $("#hca-refresh");
  const log = $("#hca-log");
  const input = $("#hca-input");
  const sendBtn = $("#hca-send");
  const hint = $("#hca-hint");
  const hintText = $("#hca-hint-text");
  const hintClose = hint.querySelector(".hca-hint-close");

  /* ---------- Icons ---------- */
  $("#hca-fab-icon").src  = window.HCA_BASE_ICON;
  $("#hca-head-icon").src = window.HCA_BASE_ICON;

  /* ---------- Header session tag ---------- */
  const titleEl = $("#hca-title");
  if (titleEl) titleEl.textContent = "HCA Assistant";

  /* ---------- First message (IST greeting) ---------- */
  appendMsg(buildWelcomeLine(), "bot");
  hintText.textContent = buildWelcomeLine();

  /* ---------- Hint logic ---------- */
  const USED_KEY = "hca_used_this_session";
  let memOK = true; try{ sessionStorage.setItem("_hca_test","1"); sessionStorage.removeItem("_hca_test"); }catch{ memOK=false; }
  let usedInMem = false;
  const hasUsed  = () => memOK ? sessionStorage.getItem(USED_KEY) === "1" : usedInMem;
  const markUsed = () => { if(memOK){ sessionStorage.setItem(USED_KEY,"1"); } else { usedInMem = true; } };
  const clearUsed= () => { if(memOK){ sessionStorage.removeItem(USED_KEY); } else { usedInMem = false; } };

  const HINT_DELAY_MS = 1000;
  const HINT_RESHOW_AFTER_CLOSE_MS = 10000;
  const HINT_IDLE_RESHOW_MS = 45000;
  let hintTimer = null;

  function scheduleHint(ms){ clearTimeout(hintTimer); hintTimer = setTimeout(showHint, ms); }
  function showHint(){ if(!panel.classList.contains("open")) hint.classList.add("show"); }
  function hideHint(){ hint.classList.remove("show"); }

  setTimeout(() => { if(!hasUsed()) showHint(); }, HINT_DELAY_MS);
  hint.addEventListener("click", () => { hideHint(); togglePanel(true); markUsed(); });
  hintClose.addEventListener("click", (e) => { e.stopPropagation(); hideHint(); });

  function togglePanel(show){
    panel.classList[show ? "add" : "remove"]("open");
    if(show){
      input.focus(); hideHint(); markUsed(); clearTimeout(hintTimer);
    }
  }
  fab.onclick = () => togglePanel(true);
  closeBtn.onclick = () => { togglePanel(false); clearUsed(); scheduleHint(HINT_RESHOW_AFTER_CLOSE_MS); };

  /* ---------- CONTACT AUTO-LINK HELPERS ---------- */
  function addHttp(url){ return /^https?:\/\//i.test(url) ? url : `https://${url}`; }
  function digits(s){ return String(s||"").replace(/[^\d]/g,""); }
  function telHref(s){ return `tel:${digits(s)}`; }
  function waHref(s){
    let n = digits(s);
    if (n.length <= 10) n = "91" + n; // assume local Indian number -> +91
    return `https://wa.me/${n}`;
  }

  /* ---------- Minimal Markdown renderer with SAFE autolinking ---------- */
  function renderMarkdown(input){
    const escapeHtml = (s) =>
      String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    const text = escapeHtml(input).replace(/\r\n/g, "\n");

    const inline = (s) => {
      // Normalize visible wa.me URLs -> clean label// Explicit Call/Phone labels (not inside a tag)
      s = s.replace(
        /(?![^<]*>)(Call|Phone|Mobile|Number|Tel(?:ephone)?)\s*[:\-]?\s*([+]?[\d\s().-]{6,}\d)/gi,
        (_m, label, num) =>
          `<a href="${telHref(num)}" target="_blank" rel="noopener">${label}: ${num.replace(/\s+/g, " ").trim()}</a>`
      );
      s = s.replace(
        /(?![^<]*>)(?:https?:\/\/)?wa\.me\/(\d{6,})/gi,
        (_m, num) => `<a href="https://wa.me/${num}" target="_blank" rel="noopener">WhatsApp</a>`
      );

      // Markdown links
      s = s.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'
      );

      // Emails (not inside a tag)
      s = s.replace(
        /(?![^<]*>)([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,
        '<a href="mailto:$1" target="_blank" rel="noopener">$1</a>'
      );

      // Explicit WhatsApp labels (not inside a tag)
      s = s.replace(
        /(?![^<]*>)(WhatsApp|Whatsapp|WA)\s*[:\-]?\s*([+]?[\d\s().-]{6,}\d)/gi,
        (_m, _w, num) => `<a href="${waHref(num)}" target="_blank" rel="noopener">WhatsApp: ${num.replace(/\s+/g," ").trim()}</a>`
      );

      // Generic phone numbers (not inside a tag)
      s = s.replace(
        /(?![^<]*>)(?<!\w)(\+?[\d][\d\s().-]{6,}\d)(?!\w)/g,
        (m) => `<a href="${telHref(m)}" target="_blank" rel="noopener">${m}</a>`
      );

      // Bare URLs (not inside a tag)
      s = s.replace(
        /(?![^<]*>)(\b(?:https?:\/\/|www\.)[^\s<)]+[^\s<).,!?:;])/gi,
        (m) => `<a href="${addHttp(m)}" target="_blank" rel="noopener">${m.replace(/^https?:\/\//i,'')}</a>`
      );

      // Code / bold / italics
      s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/(^|[\s(])\*([^*\n]+)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
      return s;
    };

    // Blocks + simple lists
    const lines = text.split("\n");
    let html = "", inList = false;
    const closeList = () => { if(inList){ html += "</ul>"; inList = false; } };

    for (let i = 0; i < lines.length; i++){
      const line = lines[i];
      const m = line.match(/^\s*[*-]\s+(.+)/);
      if (m){ if(!inList){ html += "<ul>"; inList = true; } html += `<li>${inline(m[1].trim())}</li>`; continue; }
      if (line.trim() === ""){ closeList(); html += "<br/>"; continue; }
      closeList(); html += inline(line) + "<br/>";
    }
    closeList();
    return html;
  }

  /* ---------- Message helpers ---------- */
  function appendMsg(text, who="bot"){
    const row = document.createElement("div");
    row.className = `hca-row ${who}`;

    const avatar = document.createElement("div");
    avatar.className = "hca-avatar";
    avatar.style.backgroundImage = `url('${who === "bot" ? window.HCA_BOT_ICON : window.HCA_USER_ICON}')`;

    const bubble = document.createElement("div");
    bubble.className = "hca-bubble";
    // Use HTML for both bot and user so contact details are clickable
    bubble.innerHTML = renderMarkdown(text);

    row.appendChild(avatar);
    row.appendChild(bubble);
    log.appendChild(row);
    log.scrollTop = log.scrollHeight;
    return bubble;
  }

  /* ---------- Typing indicator ---------- */
  let typingEl=null;
  function showTyping(show){
    if(show){
      if(typingEl) return;
      const row=document.createElement("div");
      row.className="hca-row bot hca-typing-row";
      const avatar=document.createElement("div");
      avatar.className="hca-avatar";
      avatar.style.backgroundImage=`url('${window.HCA_BOT_ICON}')`;
      const bubble=document.createElement("div");
      bubble.className="hca-typing-bubble";
      for(let i=0;i<3;i++){const d=document.createElement("span");d.className="hca-typing-dot";bubble.appendChild(d);}
      row.appendChild(avatar);row.appendChild(bubble);
      typingEl=row;log.appendChild(typingEl);log.scrollTop=log.scrollHeight;
    }else if(typingEl){typingEl.remove();typingEl=null;}
  }

  async function resetChat(){
    log.innerHTML = "";
    appendMsg(buildWelcomeLine(), "bot");

    try{
      localStorage.removeItem("hca_history");
      sessionStorage.removeItem("hca_history");
    }catch(_){}

    try{
      await fetch(RESET, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Session-ID": SESSION_ID
        },
        credentials: "include",
        body: JSON.stringify({ sessionId: SESSION_ID })
      });
    }catch(_ignored){}

    input.value = ""; input.focus();
    scheduleHint(800);
  }
  refreshBtn.onclick = resetChat;

  /* ---------- Ask (now sends SESSION_ID in header + body) ---------- */
  async function ask(){
    const q = input.value.trim();
    if(!q) return;

    const cmd = q.toLowerCase();
    if(cmd === "/restart" || cmd === "/refresh"){ input.value=""; resetChat(); return; }

    appendMsg(q, "user");
    hideHint();

    input.value = "";
    input.disabled = true;
    sendBtn.disabled = true;
    showTyping(true);

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-Session-ID": SESSION_ID
        },
        credentials: "include",
        body: JSON.stringify({ question: q, sessionId: SESSION_ID })
      });

      const text = await res.text();
      let data = {};
      try { data = JSON.parse(text); } catch { data = { answer: text }; }

      if(!res.ok){
        const errMsg = (data && (data.error || data.details || data.message)) || `HTTP ${res.status}`;
        appendMsg(String(errMsg), "bot");
      } else {
        const answer = data.answer || data.output || "Sorry, I couldn't find that in the PDF.";
        appendMsg(answer, "bot");
      }
    }catch(e){
      appendMsg("Server error. Please try again.", "bot");
    }finally{
      showTyping(false);
      input.disabled = false;
      sendBtn.disabled = false;
      input.focus();
      clearTimeout(hintTimer);
      scheduleHint(HINT_IDLE_RESHOW_MS);
    }
  }

  sendBtn.onclick = ask;
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") ask(); });

  /* ---------- Optional health check ---------- */
  fetch(HEALTH, { credentials: "include" })
    .then(r=>r.json())
    .then(j=>console.log("HCA Assistant:", j))
    .catch(()=>{});
})();
</script>
